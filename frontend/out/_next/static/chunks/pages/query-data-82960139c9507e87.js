(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[193],{4435:(e,a,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/query-data",function(){return t(874)}])},7689:(e,a,t)=>{"use strict";t.d(a,{A:()=>l});var s=t(5105),r=t(5935),n=t.n(r);let l=()=>(0,s.jsxs)(n(),{children:[(0,s.jsx)("title",{children:"Defog.ai - AI Assistant for Data Analysis"}),(0,s.jsx)("meta",{name:"description",content:"Train your AI data assistant on your own device"}),(0,s.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,s.jsx)("link",{rel:"icon",href:"/favicon.ico"})]})},5132:(e,a,t)=>{"use strict";t.d(a,{A:()=>d});var s=t(5105),r=t(8101),n=t(6068),l=t(1392),o=t(9955),i=t(4799);let d=e=>{let{id:a,userType:t,children:d,rootClassNames:c="",contentClassNames:u="max-h-full h-full",containerClassNames:m="flex flex-col md:min-h-screen relative container mx-auto"}=e,[h,f]=(0,r.useState)([]),y=(0,n.useRouter)(),p=e=>{y.push(e)},g=()=>{localStorage.removeItem("defogUser"),localStorage.removeItem("defogToken"),localStorage.removeItem("defogUserType"),p("/log-in")},x=(0,o.usePathname)();return(0,r.useEffect)(()=>{f(("admin"==t?[{title:"Admin",href:"#!",children:[{key:"manage-database",title:"Manage Database",href:"/extract-metadata"},{key:"align-model",title:"Align Model",href:"/align-model"}]},{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:g}]:t?[{key:"query-data",title:"Query Data",href:"/query-data"},{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:g}]:[]).map(e=>(e.current=e.href==x,e)).map(e=>(e.children&&(e.children=e.children.map(e=>(e.current=e.href==x,e))),e)))},[t]),(0,s.jsxs)("div",{className:(0,i.QP)(m,c),children:[h.length?(0,s.jsx)(l.jq,{rootClassNames:(0,i.QP)("border-b dark:border-dark-border","bg-white dark:bg-dark-bg-primary","text-primary-text dark:text-dark-text-primary"),items:h.map(e=>({...e,classNames:(0,i.QP)(e.classNames,"hover:bg-gray-100 dark:hover:bg-dark-hover",e.current&&"bg-gray-100 dark:bg-dark-hover")}))}):(0,s.jsx)(s.Fragment,{}),(0,s.jsx)("div",{className:u,children:d})]})}},874:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>x});var s=t(5105),r=t(8101),n=t(6068),l=t(7689),o=t(5132),i=t(1392),d=t(3790),c=t(1402);function u({metadata:e=null}){(0,r.useMemo)(()=>e&&Array.isArray(e)?Array.from(new Set(e.map(e=>e.table_name))):[],[e]);let a=Array.isArray(e)?[{dataIndex:"table_name",title:"table_name",key:"table_name"},{dataIndex:"column_name",title:"column_name",key:"column_name"},{dataIndex:"column_description",title:"column_description",key:"column_description"},{dataIndex:"data_type",title:"data_type",key:"data_type"}]:[];return e?c.j.jsx(d.E,{children:Array.isArray(e)&&c.j.jsx(c.j.Fragment,{children:c.j.jsx("div",{className:"flex flex-col justify-center w-full",children:c.j.jsx(c.d,{pagination:{defaultPageSize:10},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:a,rows:e,columnHeaderClassNames:"py-2"})})})}):c.j.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-50 text-sm text-gray-400",children:"No metadata available"})}let m=({progress:e})=>c.j.jsxs("div",{className:"w-3/4 max-w-md mx-auto",children:[c.j.jsxs("div",{className:"mb-2 flex justify-between text-xs text-gray-600 dark:text-gray-300",children:[c.j.jsx("span",{children:"Uploading file..."}),c.j.jsxs("span",{children:[e,"%"]})]}),c.j.jsx("div",{className:"w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:c.j.jsx("div",{className:"h-full bg-blue-500 transition-all duration-300 ease-out",style:{width:`${e}%`}})})]}),h=({apiEndpoint:e,token:a,onDbCreated:t=(...e)=>{}})=>{let s=(0,r.useContext)(c.M),[n,l]=(0,r.useState)(!1),[o,i]=(0,r.useState)(0),d=async r=>{if(console.time("QueryDataNewDb:processAndUploadFile"),!r||!(0,c.i)(r.type))throw Error("Only CSV or Excel files are accepted");console.time("QueryDataNewDb:uploadMultipleFilesAsDb");let{dbName:n}=await (0,c.u)(e,a,[r],e=>{i(e)});console.timeEnd("QueryDataNewDb:uploadMultipleFilesAsDb"),s.success(`DB ${n} created successfully`),t(n),console.timeEnd("QueryDataNewDb:processAndUploadFile")};return c.j.jsxs("div",{className:"min-w-full min-h-full",children:[c.j.jsx(c.D,{disabled:n,rootClassNames:(0,c.t)(n?"hidden":""),acceptedFileTypes:Object.values(c.F),showIcon:!0,onFileSelect:async e=>{console.time("QueryDataNewDb:onFileSelect"),l(!0),i(0),e.preventDefault(),e.stopPropagation();try{let a=e.target.files[0];await d(a)}catch(e){console.error(e),s.error(e.message||"Failed to parse the file")}finally{l(!1),console.timeEnd("QueryDataNewDb:onFileSelect")}},onDrop:async e=>{var a,t;console.time("QueryDataNewDb:onDrop"),l(!0),i(0),e.preventDefault(),e.stopPropagation();try{let s=null==(t=null==(a=null==e?void 0:e.dataTransfer)?void 0:a.items)?void 0:t[0];if(!s||!s.kind||"file"!==s.kind)throw Error("Invalid file");if(!(0,c.i)(s.type))throw Error("Only CSV or Excel files are accepted");let r=s.getAsFile();await d(r)}catch(e){s.error(e.message||"Failed to parse the file"),console.log(e.stack)}finally{l(!1),console.timeEnd("QueryDataNewDb:onDrop")}}}),n&&c.j.jsxs("div",{className:"flex flex-col w-full h-full items-center justify-center gap-4 text-gray-600 dark:text-gray-300",children:[c.j.jsxs("div",{className:"text-xs flex gap-1",children:[c.j.jsx(c.b,{})," ",o>0?`Uploading your file (${o}%)`:"Uploading your file"]}),o>0&&c.j.jsx("div",{className:"w-3/4 max-w-md",children:c.j.jsx(m,{progress:o})})]})]})};function f({apiEndpoint:e,token:a,initialDbList:t=[],initialTrees:s={},hideRawAnalysis:n=!1,hiddenCharts:l=[],hideSqlTab:o=!1,hidePreviewTabs:i=!1,searchBarDraggable:m=!1,onTreeChange:f=(...e)=>{}}){let[y,p]=(0,r.useState)(!1),[g,x]=(0,r.useState)((0,d.W)({token:a,hideRawAnalysis:n,hiddenCharts:l,hideSqlTab:o,hidePreviewTabs:i,apiEndpoint:e}));g.updateConfig=e=>{x(a=>({...a,...e}))};let{current:j}=(0,r.useRef)(crypto.randomUUID().toString()),[b,w]=(0,r.useState)(t),N=(0,r.useRef)(t.reduce((e,a)=>(e[a.name]={dbName:a.name,predefinedQuestions:a.predefinedQuestions,treeManager:(0,d.A)(s[a.name]||{})},e),{})),[v,_]=(0,r.useState)(null),{current:k}=(0,r.useRef)((0,c.m)()),[S,T]=(0,r.useState)(!1);(0,r.useEffect)(()=>{!async function(){let t={};for await(let s of b)if(s.name!==j)try{let r=await (0,c.v)(e,a,s.name);t[s.name]=r}catch(e){console.error(e),t[s.name]=null}let s=b.map(e=>({...e,metadata:t[e.name]}));_(s[0]),w(s),p(!0)}()},[]);let D=(0,r.useMemo)(()=>v&&y?c.j.jsx(c.g,{label:"Select database",popupClassName:"!max-w-full",rootClassNames:"mb-2",value:null==v?void 0:v.name,allowClear:!1,placeholder:"Select Database",allowCreateNewOption:!1,options:[{value:j,label:"Upload new"}].concat(b.map(e=>({value:e.name,label:e.name}))),onChange:e=>{let a=b.find(a=>a.name===e);e===j?T(!0):_(a||b[0])}}):null,[v,b]),C=(0,r.useRef)(null);(0,r.useEffect)(()=>{C.current&&(_(b.find(e=>e.name===C.current)||b[0]),C.current=null)},[b]);let E=(0,r.useMemo)(()=>v&&y?c.j.jsx(d.E,{children:c.j.jsx(d.X,{defaultSidebarOpen:!0,beforeTitle:D,searchBarDraggable:m,dbName:v.name,metadata:v.metadata,analysisTreeManager:N.current[v.name].treeManager,autoScroll:!0,predefinedQuestions:v.predefinedQuestions||[],onTreeChange:(e,a)=>{try{f(e,a)}catch(e){console.error(e)}}})}):null,[v,D,y]),A=(0,r.useMemo)(()=>v&&y?c.j.jsx(u,{metadata:v.metadata}):null,[b,v,y,D]),P=(0,r.useMemo)(()=>[{name:"Query",content:E},{name:"View data structure",content:A}],[E,A]),I=(0,r.useMemo)(()=>c.j.jsx(h,{apiEndpoint:e,token:a,onDbCreated:async t=>{try{N.current={...N.current,[t]:{dbName:t,treeManager:(0,d.A)()}};let s=await (0,c.v)(e,a,t);w(e=>[...e,{name:t,predefinedQuestions:["What are the tables available?","Show me 5 rows"],metadata:s}]),k.success("Database uploaded successfully, access it by the name: "+t),C.current=t}catch(e){k.error(e)}finally{T(!1)}}}),[b]);return c.j.jsxs(c.M.Provider,{value:k,children:[c.j.jsx(c.o,{rootClassNames:"absolute left-0 right-0"}),c.j.jsx(d.Q.Provider,{value:g,children:c.j.jsxs("div",{className:"relative w-full h-full p-2",children:[y?null!=b&&b.length?c.j.jsx(c.T,{size:"small",tabs:P,vertical:!0,contentClassNames:"p-0 mt-2 sm:mt-0 bg-white dark:bg-gray-800",defaultTabClassNames:"p-0 sm:mt-0 h-full",selectedTabHeaderClasses:e=>"Tree"===e?"bg-transparent":""}):c.j.jsx("div",{className:"w-full h-full flex items-center justify-center",children:I}):c.j.jsx("div",{className:"w-full h-full flex items-center justify-center",children:c.j.jsx(c.b,{})}),c.j.jsx(c.s,{title:"Upload new database",open:S,footer:!1,onCancel:()=>T(!1),children:I})]})})]})}var y=t(8359);function p(e){let{token:a,dbs:t,hideSqlTab:n=!1,hidePreviewTabs:l=!1,hiddenCharts:o=[],hideRawAnalysis:d=!1}=e,[c,u]=(0,r.useState)(null),[m,h]=(0,r.useState)(!0),[p,g]=(0,r.useState)(null);(0,r.useEffect)(()=>{fetch("".concat(y.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"","/get_user_history"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:a})}).then(e=>e.ok?e.json():{error:"Could not fetch user history"}).then(e=>{if(e.error){g(e.error);return}h(!1),u(e.history||{})})},[]);let x=(0,r.useCallback)((e,t)=>{if(e&&t)try{fetch("".concat(y.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"","/update_user_history"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:a,history:t,db_name:e})}).then(e=>e.json()).then(e=>{if(e.error)throw Error(e.error)})}catch(e){console.error(e)}},[]);return m||p||!c?(0,s.jsx)("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:p?"".concat(p):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.c5,{})," Loading"]})}):(0,s.jsx)(f,{initialDbList:t,hiddenCharts:["boxplot","histogram"],token:a,searchBarDraggable:!1,hidePreviewTabs:!1,apiEndpoint:y.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"",initialTrees:c,hideRawAnalysis:d,hideSqlTab:n,onTreeChange:(e,a)=>{x(e,a)}})}var g=t(8359);let x=()=>{let e=(0,n.useRouter)(),[a,t]=(0,r.useState)(""),[d,c]=(0,r.useState)(""),[u,m]=(0,r.useState)(""),[h,f]=(0,r.useState)([]),[y,x]=(0,r.useState)(!1),[j,b]=(0,r.useState)(!1),[w,N]=(0,r.useState)({}),v=async e=>{x(!0);let a=await fetch((g.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"")+"/get_db_names",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!a.ok)throw x(!1),Error("Failed to get api key names - are you sure your network is working?");let t=await a.json();if(f(t.db_names),!(a=await fetch((g.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"")+"/get_non_admin_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})})).ok)throw x(!1),Error("Failed to get non admin config - are you sure your network is working?");N(t=await a.json()),x(!1)};console.log(w),(0,r.useEffect)(()=>{let a=localStorage.getItem("defogToken"),s=localStorage.getItem("defogUserType");if(c(localStorage.getItem("defogUser")),m(s),t(a),!a){b(!0),setTimeout(()=>{let a=window.location.pathname+window.location.search;e.push({pathname:"/log-in",query:{message:"You are not logged in. Please log in to access query data.",returnUrl:a}})},1500);return}v(a)},[e]);let _="admin"===u;return(0,s.jsxs)("div",{className:"max-h-screen h-screen",children:[(0,s.jsx)(l.A,{}),(0,s.jsx)(o.A,{id:"query-data",userType:u,containerClassNames:"max-h-screen h-screen flex flex-col",contentClassNames:"h-full max-h-full",children:j?(0,s.jsxs)("div",{className:"w-full h-full flex flex-col justify-center items-center text-gray-400 text-sm",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Not Logged In"}),(0,s.jsx)("p",{className:"mb-4",children:"You are not logged in. Redirecting to login page..."}),(0,s.jsx)(i.c5,{})]}):a?y?(0,s.jsxs)("div",{className:"w-full h-full flex justify-center items-center text-gray-400 text-sm",children:["Loading DBs ",(0,s.jsx)(i.c5,{classNames:"ml-4"})]}):(0,s.jsx)(p,{token:a,devMode:!1,isAdmin:_,hideSqlTab:!_&&w.hide_sql_tab_for_non_admin,hidePreviewTabs:!_&&w.hide_preview_tabs_for_non_admin,hiddenCharts:_?[]:w.hidden_charts_for_non_admin||[],hideRawAnalysis:!_&&w.hide_raw_analysis_for_non_admin,dbs:(h.length>0?h:[]).map(e=>({name:e,keyName:e,predefinedQuestions:"Manufacturing"===e?["What is the average rejection rate by lot?","Is there a difference in the plasticity of components that are rejected vs accepted?"]:"Sales"===e?["Who are our top 5 customers by revenue?","What was the month on month change in revenue?"]:"Slack"===e?["What is the count of number of queries by db type in the last 30 days, except for queries made by jp@defog.ai?","Which users have the most queries?"]:["Show me any 5 rows from the first table"]}))}):(0,s.jsx)("div",{className:"w-full h-full flex justify-center items-center text-gray-400 text-sm",children:"No token found. Please log out and log back in."})})]})}}},e=>{var a=a=>e(e.s=a);e.O(0,[573,48,951,636,593,792],()=>a(4435)),_N_E=e.O()}]);